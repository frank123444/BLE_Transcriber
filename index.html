<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Transcriber">
    <meta name="description" content="Real-time audio transcription from Bluetooth headsets and microphones">
    <meta name="theme-color" content="#007AFF">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23007AFF' width='100' height='100' rx='20'/><text x='50' y='68' font-size='50' text-anchor='middle' fill='white'>üéôÔ∏è</text></svg>">
    <title>Bluetooth Audio Transcriber</title>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

```
    :root {
        --primary: #007AFF;
        --danger: #FF3B30;
        --success: #34C759;
        --warning: #FF9500;
        --bg: #F2F2F7;
        --card: #FFFFFF;
        --text: #1C1C1E;
        --text-secondary: #8E8E93;
        --border: #E5E5EA;
    }
    
    @media (prefers-color-scheme: dark) {
        :root {
            --bg: #000000;
            --card: #1C1C1E;
            --text: #FFFFFF;
            --text-secondary: #8E8E93;
            --border: #38383A;
        }
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
        margin: 0;
        padding: 0;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        min-height: -webkit-fill-available;
        display: flex;
        flex-direction: column;
    }
    
    html {
        height: -webkit-fill-available;
    }
    
    .header {
        background: var(--card);
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        z-index: 100;
    }
    
    .header h1 {
        font-size: 17px;
        font-weight: 600;
        margin: 0;
    }
    
    .header-btn {
        background: none;
        border: none;
        color: var(--primary);
        font-size: 17px;
        padding: 8px;
        cursor: pointer;
    }
    
    .audio-source {
        background: var(--card);
        padding: 12px 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        border-bottom: 1px solid var(--border);
    }
    
    .source-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--bg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
    }
    
    .source-icon.active {
        background: rgba(52, 199, 89, 0.15);
    }
    
    .source-info {
        flex: 1;
    }
    
    .source-label {
        font-size: 12px;
        color: var(--text-secondary);
    }
    
    .source-name {
        font-size: 15px;
        font-weight: 500;
    }
    
    .audio-level {
        display: flex;
        gap: 3px;
        align-items: flex-end;
        height: 24px;
    }
    
    .level-bar {
        width: 4px;
        background: var(--border);
        border-radius: 2px;
        transition: all 0.1s ease;
    }
    
    .level-bar.active {
        background: var(--success);
    }
    
    .level-bar.warning {
        background: var(--warning);
    }
    
    .level-bar.danger {
        background: var(--danger);
    }
    
    .transcription-area {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
    }
    
    .empty-state svg {
        width: 80px;
        height: 80px;
        margin-bottom: 20px;
        opacity: 0.3;
    }
    
    .empty-state h2 {
        font-size: 20px;
        font-weight: 600;
        margin: 0 0 8px 0;
        color: var(--text);
    }
    
    .empty-state p {
        font-size: 15px;
        margin: 0;
        max-width: 280px;
    }
    
    .transcription-text {
        font-size: 17px;
        line-height: 1.5;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    
    .partial {
        color: var(--text-secondary);
        font-style: italic;
    }
    
    .control-panel {
        background: var(--card);
        padding: 16px 20px calc(16px + env(safe-area-inset-bottom, 0px));
        border-top: 1px solid var(--border);
    }
    
    .status-row {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-bottom: 16px;
    }
    
    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--warning);
    }
    
    .status-dot.recording {
        background: var(--success);
        animation: pulse 1.5s infinite;
    }
    
    .status-dot.error {
        background: var(--danger);
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .status-text {
        font-size: 13px;
        color: var(--text-secondary);
    }
    
    .main-btn {
        width: 100%;
        padding: 16px;
        border: none;
        border-radius: 12px;
        font-size: 17px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: all 0.2s ease;
    }
    
    .main-btn.start {
        background: var(--primary);
        color: white;
    }
    
    .main-btn.stop {
        background: var(--danger);
        color: white;
    }
    
    .main-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .main-btn:active:not(:disabled) {
        transform: scale(0.98);
    }
    
    .action-row {
        display: flex;
        gap: 12px;
        margin-top: 12px;
    }
    
    .action-btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 10px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        background: var(--bg);
        color: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }
    
    .action-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }
    
    .toast {
        position: fixed;
        bottom: 140px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: var(--text);
        color: var(--bg);
        padding: 12px 24px;
        border-radius: 25px;
        font-size: 15px;
        font-weight: 500;
        opacity: 0;
        transition: all 0.3s ease;
        z-index: 1000;
    }
    
    .toast.show {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }
    
    .error-banner {
        background: rgba(255, 59, 48, 0.1);
        color: var(--danger);
        padding: 12px 20px;
        font-size: 14px;
        display: none;
    }
    
    .error-banner.show {
        display: block;
    }
    
    .language-select {
        background: var(--bg);
        border: none;
        border-radius: 8px;
        padding: 8px 12px;
        font-size: 14px;
        color: var(--text);
        cursor: pointer;
    }
    
    @supports (-webkit-touch-callout: none) {
        .language-select {
            -webkit-appearance: none;
            appearance: none;
            padding-right: 24px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238E8E93' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
        }
    }
</style>
```

</head>
<body>
    <div class="header">
        <button class="header-btn" id="clearBtn">Clear</button>
        <h1>Audio Transcriber</h1>
        <select class="language-select" id="languageSelect">
            <option value="en-US">English</option>
            <option value="de-DE">Deutsch</option>
            <option value="fr-FR">Fran√ßais</option>
            <option value="es-ES">Espa√±ol</option>
            <option value="it-IT">Italiano</option>
            <option value="pt-BR">Portugu√™s</option>
            <option value="nl-NL">Nederlands</option>
            <option value="pl-PL">Polski</option>
            <option value="ru-RU">–†—É—Å—Å–∫–∏–π</option>
            <option value="zh-CN">‰∏≠Êñá</option>
            <option value="ja-JP">Êó•Êú¨Ë™û</option>
            <option value="ko-KR">ÌïúÍµ≠Ïñ¥</option>
            <option value="ar-SA">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
            <option value="hi-IN">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
        </select>
    </div>

```
<div class="error-banner" id="errorBanner"></div>

<div class="audio-source">
    <div class="source-icon" id="sourceIcon">üéôÔ∏è</div>
    <div class="source-info">
        <div class="source-label">Audio Input</div>
        <div class="source-name" id="sourceName">Default Microphone</div>
    </div>
    <div class="audio-level" id="audioLevel">
        <div class="level-bar" style="height: 6px;"></div>
        <div class="level-bar" style="height: 10px;"></div>
        <div class="level-bar" style="height: 14px;"></div>
        <div class="level-bar" style="height: 18px;"></div>
        <div class="level-bar" style="height: 22px;"></div>
    </div>
</div>

<div class="transcription-area" id="transcriptionArea">
    <div class="empty-state" id="emptyState">
        <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5z"/>
            <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
        </svg>
        <h2>Ready to Transcribe</h2>
        <p>Connect your Bluetooth headset and tap Start to begin real-time transcription.</p>
    </div>
    <div class="transcription-text" id="transcriptionText" style="display: none;"></div>
</div>

<div class="control-panel">
    <div class="status-row">
        <div class="status-dot" id="statusDot"></div>
        <span class="status-text" id="statusText">Ready</span>
    </div>
    
    <button class="main-btn start" id="mainBtn">
        <span>üéôÔ∏è</span>
        <span id="mainBtnText">Start</span>
    </button>
    
    <div class="action-row">
        <button class="action-btn" id="copyBtn" disabled>
            <span>üìã</span> Copy
        </button>
        <button class="action-btn" id="shareBtn" disabled>
            <span>üì§</span> Share
        </button>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
    // Check for browser support
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    
    if (!SpeechRecognition) {
        document.getElementById('errorBanner').textContent = 
            '‚ö†Ô∏è Speech recognition is not supported in this browser. Please use Safari on iOS or Chrome on desktop.';
        document.getElementById('errorBanner').classList.add('show');
        document.getElementById('mainBtn').disabled = true;
    }
    
    // State
    let recognition = null;
    let isRecording = false;
    let fullTranscription = '';
    let audioContext = null;
    let analyser = null;
    let mediaStream = null;
    let levelAnimationFrame = null;
    
    // DOM Elements
    const mainBtn = document.getElementById('mainBtn');
    const mainBtnText = document.getElementById('mainBtnText');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const transcriptionText = document.getElementById('transcriptionText');
    const emptyState = document.getElementById('emptyState');
    const sourceIcon = document.getElementById('sourceIcon');
    const sourceName = document.getElementById('sourceName');
    const copyBtn = document.getElementById('copyBtn');
    const shareBtn = document.getElementById('shareBtn');
    const clearBtn = document.getElementById('clearBtn');
    const toast = document.getElementById('toast');
    const errorBanner = document.getElementById('errorBanner');
    const languageSelect = document.getElementById('languageSelect');
    const levelBars = document.querySelectorAll('.level-bar');
    
    // Initialize Speech Recognition
    function initRecognition() {
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = languageSelect.value;
        
        recognition.onstart = () => {
            console.log('Recognition started');
            updateUI(true);
        };
        
        recognition.onend = () => {
            console.log('Recognition ended');
            if (isRecording) {
                // Auto-restart if still recording
                try {
                    recognition.start();
                } catch (e) {
                    console.log('Restart failed:', e);
                    stopRecording();
                }
            } else {
                updateUI(false);
            }
        };
        
        recognition.onerror = (event) => {
            console.error('Recognition error:', event.error);
            
            if (event.error === 'not-allowed') {
                showError('Microphone access denied. Please enable it in Settings.');
                stopRecording();
            } else if (event.error === 'no-speech') {
                // Ignore, will auto-restart
            } else if (event.error !== 'aborted') {
                showError(`Error: ${event.error}`);
            }
        };
        
        recognition.onresult = (event) => {
            let interimTranscript = '';
            let finalTranscript = '';
            
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    finalTranscript += transcript + ' ';
                } else {
                    interimTranscript += transcript;
                }
            }
            
            if (finalTranscript) {
                fullTranscription += finalTranscript;
            }
            
            updateTranscriptionDisplay(interimTranscript);
        };
    }
    
    // Start recording
    async function startRecording() {
        try {
            // Request microphone access
            mediaStream = await navigator.mediaDevices.getUserMedia({ 
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                }
            });
            
            // Get audio source info
            const audioTrack = mediaStream.getAudioTracks()[0];
            updateAudioSource(audioTrack.label || 'Microphone');
            
            // Setup audio level monitoring
            setupAudioAnalyser(mediaStream);
            
            // Initialize and start recognition
            initRecognition();
            recognition.start();
            isRecording = true;
            
        } catch (err) {
            console.error('Error starting:', err);
            showError('Could not access microphone. Please check permissions.');
        }
    }
    
    // Stop recording
    function stopRecording() {
        isRecording = false;
        
        if (recognition) {
            recognition.stop();
            recognition = null;
        }
        
        if (mediaStream) {
            mediaStream.getTracks().forEach(track => track.stop());
            mediaStream = null;
        }
        
        if (audioContext) {
            audioContext.close();
            audioContext = null;
        }
        
        if (levelAnimationFrame) {
            cancelAnimationFrame(levelAnimationFrame);
            levelAnimationFrame = null;
        }
        
        updateUI(false);
        resetAudioLevels();
    }
    
    // Setup audio analyser for level monitoring
    function setupAudioAnalyser(stream) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        const source = audioContext.createMediaStreamSource(stream);
        source.connect(analyser);
        analyser.fftSize = 256;
        
        updateAudioLevels();
    }
    
    // Update audio level visualization
    function updateAudioLevels() {
        if (!analyser || !isRecording) return;
        
        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(dataArray);
        
        // Calculate average level
        const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
        const normalized = Math.min(average / 128, 1);
        
        // Update bars
        levelBars.forEach((bar, index) => {
            const threshold = (index + 1) / 5;
            const isActive = normalized >= threshold - 0.1;
            
            bar.classList.remove('active', 'warning', 'danger');
            if (isActive) {
                if (index < 3) bar.classList.add('active');
                else if (index < 4) bar.classList.add('warning');
                else bar.classList.add('danger');
            }
        });
        
        levelAnimationFrame = requestAnimationFrame(updateAudioLevels);
    }
    
    // Reset audio level bars
    function resetAudioLevels() {
        levelBars.forEach(bar => {
            bar.classList.remove('active', 'warning', 'danger');
        });
    }
    
    // Update UI state
    function updateUI(recording) {
        if (recording) {
            mainBtn.className = 'main-btn stop';
            mainBtnText.textContent = 'Stop';
            statusDot.classList.add('recording');
            statusText.textContent = 'Transcribing...';
            sourceIcon.classList.add('active');
        } else {
            mainBtn.className = 'main-btn start';
            mainBtnText.textContent = 'Start';
            statusDot.classList.remove('recording');
            statusText.textContent = 'Ready';
            sourceIcon.classList.remove('active');
        }
        
        updateActionButtons();
    }
    
    // Update transcription display
    function updateTranscriptionDisplay(interim = '') {
        if (fullTranscription || interim) {
            emptyState.style.display = 'none';
            transcriptionText.style.display = 'block';
            
            let html = fullTranscription;
            if (interim) {
                html += `<span class="partial">${interim}</span>`;
            }
            transcriptionText.innerHTML = html;
            
            // Auto-scroll
            transcriptionText.scrollIntoView({ behavior: 'smooth', block: 'end' });
        } else {
            emptyState.style.display = 'flex';
            transcriptionText.style.display = 'none';
        }
        
        updateActionButtons();
    }
    
    // Update audio source display
    function updateAudioSource(name) {
        sourceName.textContent = name;
        
        // Update icon based on source type
        const lowerName = name.toLowerCase();
        if (lowerName.includes('airpod') || lowerName.includes('bluetooth') || lowerName.includes('wireless')) {
            sourceIcon.textContent = 'üéß';
        } else if (lowerName.includes('wired') || lowerName.includes('headphone')) {
            sourceIcon.textContent = 'üéß';
        } else {
            sourceIcon.textContent = 'üéôÔ∏è';
        }
    }
    
    // Update action buttons
    function updateActionButtons() {
        const hasText = fullTranscription.trim().length > 0;
        copyBtn.disabled = !hasText;
        shareBtn.disabled = !hasText || !navigator.share;
    }
    
    // Show error
    function showError(message) {
        errorBanner.textContent = '‚ö†Ô∏è ' + message;
        errorBanner.classList.add('show');
        statusDot.classList.add('error');
        
        setTimeout(() => {
            errorBanner.classList.remove('show');
            statusDot.classList.remove('error');
        }, 5000);
    }
    
    // Show toast
    function showToast(message) {
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2000);
    }
    
    // Event listeners
    mainBtn.addEventListener('click', () => {
        if (isRecording) {
            stopRecording();
        } else {
            startRecording();
        }
    });
    
    copyBtn.addEventListener('click', async () => {
        try {
            await navigator.clipboard.writeText(fullTranscription.trim());
            showToast('Copied to clipboard');
        } catch (err) {
            const textarea = document.createElement('textarea');
            textarea.value = fullTranscription.trim();
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showToast('Copied to clipboard');
        }
    });
    
    shareBtn.addEventListener('click', async () => {
        if (navigator.share) {
            try {
                await navigator.share({
                    title: 'Transcription',
                    text: fullTranscription.trim()
                });
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error('Share failed:', err);
                }
            }
        }
    });
    
    clearBtn.addEventListener('click', () => {
        fullTranscription = '';
        updateTranscriptionDisplay();
    });
    
    languageSelect.addEventListener('change', () => {
        if (recognition) {
            recognition.lang = languageSelect.value;
        }
    });
    
    // Prevent zoom on double-tap
    let lastTouchEnd = 0;
    document.addEventListener('touchend', (e) => {
        const now = Date.now();
        if (now - lastTouchEnd <= 300) {
            e.preventDefault();
        }
        lastTouchEnd = now;
    }, false);
</script>
```

</body>
</html>